<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DiceGame</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script src="https://unpkg.com/mithril/mithril.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload"
         data-client_id="1052696427629-5b2tmpkb5ljfl5jveqcvgojn1i7fm3ds.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>

    <p id="toto"></p> 

</head>
<body>

<script>	
var userProfile = "test";  // Initialiser la variable pour stocker l'utilisateur
var DiceGame = {
  turn: 0,
  d1: 1,
  d2: 1,
  name: 'Houdart',
  score: 0,

  play: function() {
    if (this.turn < 10) {
      this.d1 = Math.floor((Math.random() * 5) + 1);
      this.d2 = Math.floor((Math.random() * 5) + 1);
      if (this.d1 + this.d2 == 7) {
        this.score += 10;
      }
      this.turn++;
    } else {
      Score.save(this.score, this.name);
      Myscore.save(this.score, this.name);
      this.turn = 0;
      this.score = 0;
    }
  }
};

var DiceView = {
  view: function() {
    return m('div', [
      m('div',{class:'subtitle'},"Just play here"),
      m("input[type=text][placeholder=name]", {
        value: DiceGame.name,
        class: 'input is-rounded',
        oninput: function (e) {
          e.target.value = DiceGame.name;
        }
      }),
      m('div',{class:'level'},[
        m('label',{class:'level-item'},"turn:"+DiceGame.turn),
        m('label',{class:'level-item'},"score:"+DiceGame.score),
      ]),
      m('label',{class:'label'},"Dice 1:"+DiceGame.d1),
      m('label',{class:'label'},"Dice 2:"+DiceGame.d2),
      m('button',{
        class: 'button is-link',
        onclick: function(e) {DiceGame.play()}
      },"play"),
    ]);
  }	
};
 
var Score = {
  list: [],
  myTop10List: [],

  loadList: function() {
    return m.request({
      method: "GET",
      url: "_ah/api/myApi/v1/topscores/"
    })
    .then(function(result) {
      Score.list = result.items;
      console.log("Top 10 Scores:", result.items);
    })
    .catch(function(error) {
      console.log("Error loading top scores:", error);
    });
  },

  loadMyTop10List: function() {
    console.log("Loading top 10 scores for:", DiceGame.name);
    return m.request({
      method: "GET",
      url: "_ah/api/myApi/v1/myscores/" + DiceGame.name + '?access_token=' + userProfile
    })
    .then(function(result) {
      Score.myTop10List = result.items;
      console.log("My Top 10 Scores:", result.items);
    })
    .catch(function(error) {
      console.log("Error loading my top 10 scores:", error);
    });
  },

  // Sauvegarder un score
save: function(score) {
    console.log("Saving score:", score);
    return m.request({
        method: "GET",
        url: "_ah/api/myApi/v1/addScoreSec?score=" + score + '&access_token=' + userProfile
    })
    .then(function(result) {
        console.log("Score saved:", result);
        Score.loadList();         // Met à jour la liste des "Top 10 Scores" (globaux)
        Score.loadMyTop10List();  // Met à jour "My Top 10 Scores" (locaux)
    })
    .catch(function(error) {
        console.error("Error saving score:", error);
        alert("Failed to save score: " + error.message); // Affiche une alerte en cas d'erreur
    });
}

};

var ScoreView = {
  oninit: Score.loadList,
  view: function() {
    return m('div', [
      m('div',{class:'subtitle'},"Top 10 Scores"),
      m('table', {class:'table is-striped'},[
        m('tr', [
          m('th', {width:"20px"}, "Name"),
          m('th', {width:"50px"}, "Score"),
        ]),
        Score.list.map(function(item) {
          return m("tr", [
            m('td', m('label', item.properties.name)),
            m('td', m('label', item.properties.score)),
          ]);
        })
      ])
    ]);
  }
};

var Myscore = {
  list: [],
  loadList: function(name = DiceGame.name) {
    console.log(userProfile);
    return m.request({
      method: "GET",
      url: "_ah/api/myApi/v1/myscores/"+name+'?access_token=' + userProfile
    })
    .then(function(result) {
      Myscore.list = result.items;
      console.log("got: (myscore loadlist)", result.items);
    });
  },
  save: function(score, name) {
    return m.request({
      method: "GET",
      url: "_ah/api/myApi/v1/addScore/" + score + "/" + name + '?access_token=' + userProfile
    })
    .then(function(result) {
      console.log("got: (myscore save)", result);
      Myscore.loadList(name);
    });
  }
};

var MyTop10ScoreView = {
  oninit: function() {
    Score.loadMyTop10List();  
  },
  view: function() {
    return m('div', [
      m('div', {class: 'subtitle'}, "My Top 10 Scores"),
      m('table', {class: 'table is-striped'}, [
        m('tr', [
          m('th', {width: "20px"}, "Name"),
          m('th', {width: "50px"}, "Score"),
        ]),
        Score.myTop10List.map(function(item) {
          return m("tr", [
            m('td', m('label', item.properties.name)),
            m('td', m('label', item.properties.score)),
          ]);
        })
      ])
    ]);
  }
};

var Hello = {
  view: function() {
    return m('div', {class:'container'}, [
      m("h1", {class: 'title'}, 'The Dice Game'),
      m('div',{class: 'tile is-ancestor'},[
        m("div", {class: 'tile'}, m('div',{class:'tile is-child box'}, m(DiceView))),
        m("div", {class: 'tile'}, m('div',{class:'tile is-child box'}, m(ScoreView))),
        m("div", {class: 'tile'}, m('div',{class:'tile is-child box'}, m(MyTop10ScoreView))),
      ])
    ]);
  }
};

function handleCredentialResponse(response) {
  const responsePayload = jwt_decode(response.credential);
  userProfile = response.credential;

  DiceGame.name = responsePayload.given_name || 'Houdart';

  const url = "_ah/api/myApi/v1/Hello"+'?access_token=' + response.credential;
  fetch(url).then(response => response.text()).then(data => document.getElementById('toto').innerHTML = data);
  m.mount(document.body, Hello);
}

</script>
</body>
</html>
